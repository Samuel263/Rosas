<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resumen de Compra</title>
    <link rel="stylesheet" href="ExperienciaDePagoEstilos.css">
    <script src="https://kit.fontawesome.com/75234c80fb.js" crossorigin="anonymous"></script>
</head>
<body>
    <div class="container">
        <div class="progress-bar">
            <div class="step completed">1</div>
            <span class="arrow-icon"><i class="fas fa-arrow-right"></i></span>
            <div class="step active">2</div>
            <span class="arrow-icon"><i class="fas fa-arrow-right"></i></span>
            <div class="step">3</div>
        </div>
        <h2>Selecciona el método de entrega</h2>
        <div class="delivery-method">
            <label class="method">
                <input type="radio" name="delivery" value="home-delivery">
                <span>Despacho a Domicilio</span>
                <p>Ingresa la dirección donde quieras recibir tu pedido</p>
            </label>
        </div>

        <!-- Formulario de ubicación para despacho a domicilio -->
        <div id="delivery-form" style="display: none;">
            <h3>Ingresa tu ubicación para despacho a domicilio</h3>
            <form id="location-form">
                <label for="region">Región:</label>
                <input type="text" id="region" name="region" required><br><br>
                <label for="comuna">Comuna:</label>
                <input type="text" id="comuna" name="comuna" required><br><br>
                <label for="direccion">Dirección:</label>
                <input type="text" id="direccion" name="direccion" required><br><br>
                <button type="submit" id="submit-location">Guardar Ubicación</button>
            </form>
        </div>

        <div class="order-summary">
            <h3>Resumen de tu compra</h3>
            <div id="product-list"></div>
            <div class="total">
                <span>Total a pagar:</span>
                <span id="total-amount"></span>
            </div>
            <p>El costo de despacho se calculará cuando se seleccione el tipo de entrega.</p>
            <button class="continue-button" id="continue-to-payment">Continuar</button>
            <div class="guarantee">
                <span><i class="fas fa-shield-alt"></i> Pago 100% seguro</span>
                <span><i class="fas fa-medal"></i> Garantía en tus productos</span>
            </div>
        </div>
    </div>
    <script src="script1.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const productList = document.getElementById('product-list');
            const totalAmountElem = document.getElementById('total-amount');
            const continueToPaymentBtn = document.getElementById('continue-to-payment');
            const deliveryMethodInput = document.querySelector('input[name="delivery"]');
            const deliveryForm = document.getElementById('delivery-form');
            const locationForm = document.getElementById('location-form');

            function getProductosSeleccionados() {
                // Obtener productos del localStorage y mostrar en la lista
                const productos = JSON.parse(localStorage.getItem('productosSeleccionados'));

                if (!productos || productos.length === 0) {
                    productList.innerHTML = '<p>No se han seleccionado productos.</p>';
                    totalAmountElem.textContent = '$0 CLP';
                } else {
                    productos.forEach(producto => {
                        const productDiv = document.createElement('div');
                        productDiv.classList.add('product');
                        // Código para mostrar productos (imagen, nombre, descripción, precio)
                        productList.appendChild(productDiv);
                    });
                    // Calcular y mostrar total a pagar
                    const total = productos.reduce((accumulator, current) => accumulator + current.price, 0);
                    totalAmountElem.textContent = formatPrice(total);
                }
            }

            function formatPrice(price) {
                // Función para formatear precio como moneda CLP
                return new Intl.NumberFormat('es-CL', {
                    style: 'currency',
                    currency: 'CLP',
                    minimumFractionDigits: 0
                }).format(price);
            }

            // Función para calcular costo de despacho según ubicación
            function calcularCostoDespacho(region, comuna, direccion) {
                // Implementa tu lógica aquí para calcular el costo
                // Puedes utilizar Google Maps API u otra fuente para calcular la distancia o usar una tabla predefinida
                // Por simplicidad, aquí solo retornamos un costo fijo de ejemplo
                return 5000; // Ejemplo de costo fijo
            }

            // Mostrar formulario de ubicación al seleccionar "Despacho a domicilio"
            deliveryMethodInput.addEventListener('change', function() {
                if (this.value === 'home-delivery') {
                    deliveryForm.style.display = 'block';
                } else {
                    deliveryForm.style.display = 'none';
                }
            });

            // Guardar ubicación ingresada por el usuario
            locationForm.addEventListener('submit', function(event) {
                event.preventDefault();
                const region = document.getElementById('region').value;
                const comuna = document.getElementById('comuna').value;
                const direccion = document.getElementById('direccion').value;
                const costoDespacho = calcularCostoDespacho(region, comuna, direccion);

                // Guardar en Firebase (implementación necesaria)
                // Aquí deberías guardar esta información asociada al usuario en tu base de datos Firebase

                // Redirigir al usuario a la página de pago
                window.location.href = 'ExperienciaDePago.html';
            });

            // Inicializar la página
            getProductosSeleccionados();

            continueToPaymentBtn.addEventListener('click', function() {
                window.location.href = 'ExperienciaDePago.html';
            });
        });
    </script>
</body>
</html>
